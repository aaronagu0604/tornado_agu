{% extends "layout/admin.html" %}
{% block content %}

<link href="/style/css/store_bigimg.css" rel="stylesheet">
<link rel="stylesheet" href="/style/css/amazeui.css" />
<script type="text/javascript" src="/style/js/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="/style/js/bigimg.js"></script>
<style>
    .rightTxt {
        padding:0 10px 0 0;
        color:#4c4c4c;
    }
    .leftLine {
        margin-top:10px;
    }
    .leftTxt{
        text-align: right;
        padding:0 5px 0 0;
    }
    .middle-img {
        position: absolute;
        left: 259px;
        top: 0px;
        width: 40px;
    }

    .up-img {
        position: absolute;
        top: -40px;
        left: 261px;
        width: 40px;
    }

    .down-img {
        position: absolute;
        top: 40px;
        left: 257px;
        width: 40px;
    }

    .left-img {
        position: absolute;
        left: 218px;
        width: 40px;
    }

    .right-img {
        position: absolute;
        left: 300px;
        width: 40px;
    }
    @media screen and (max-width:450px) {
        .middle-img {
            position: absolute;
            left: 259px;
            top: 0px;
            width: 40px;
            display: none;
        }

        .up-img {
            position: absolute;
            top: -40px;
            left: 261px;
            width: 40px;
            display: none;
        }

        .down-img {
            position: absolute;
            top: 40px;
            left: 257px;
            width: 40px;
            display: none;
        }

        .left-img {
            position: absolute;
            left: 218px;
            width: 40px;
            display: none;
        }

        .right-img {
            position: absolute;
            left: 300px;
            width: 40px;
            display: none;
        }

        .rotate_jia{
            display: none;
        }.rotate_div{
             display: none;
         }.rotate_jian{
              display: none;
          }
    }
</style>
<div class="mskeLayBg"></div>
{%set messages=handler.get_flashed_messages() %}
{% if messages %}
<div style="color: red; font-size: 0.6em; margin-bottom: 25px;">
    <div>
        {% for type, msg in messages%}
        {{msg}}
        {% endfor %}
    </div>
</div>
{% endif %}
<div class="row">
    <nav>
        <div class="navbar-header">
            <a class="navbar-brand" href="/admin/insurance_orders">返回订单</a>
        </div>
    </nav>
</div>

<link href="/style/css/store_bigimg.css" rel="stylesheet">
<script type="text/javascript" src="/style/js/layer/layer.js"></script>

<div class="row">
    <div class="col-sm-12 col-md-6">
        <div class="panel panel-primary">
            <div class="panel-body">
                <h4>订单基本信息</h4>
                <div class="row leftLine">
                    <div class="col-xs-3">订单号：</div>
                    <div class="col-xs-3 rightTxt">{{o.ordernum}}</div>
                    <div class="col-xs-3">状态：</div>
                    <div class="col-xs-3 rightTxt">
                        {% if o.status==0 %}
                        <span style="color:#FF0800;">待报价</span>
                        {% elif o.status==1  %}
                        <span style="color:#990033;">待付款</span>
                        {% elif o.status==2 %}
                        <span style="color:#00CC00;">已付款</span>
                        {% elif o.status==3 %}
                        <span style="color:#487;">已办理</span>
                        {% elif o.status==-1 %}
                        <span style="color:#000800;">已取消</span>
                        {% endif %}
                    </div>
                </div>
                <div class="row leftLine">
                    <div class="col-xs-3">订单金额：</div>
                    <div class="col-xs-3 rightTxt">--</div>
                    <div class="col-xs-3">支付方式：</div>
                    <div class="col-xs-3 rightTxt">--</div>
                </div>
                <div class="row leftLine">
                    <div class="col-xs-3">下单门店：</div>
                    <div class="col-xs-3 rightTxt">{{o.store.name}}</div>
                    <div class="col-xs-3">下单用户：</div>
                    <div class="col-xs-3 rightTxt">{{o.user.truename}}</div>

                </div>
                <div class="row leftLine">
                    <div class="col-xs-3">下单时间：</div>
                    <div class="col-xs-3 rightTxt">{{o.ordered|datetimeformat}}</div>
                    <div class="col-xs-3">联系电话：</div>
                    <div class="col-xs-3 rightTxt">{{o.user.mobile}}</div>
                </div>
                <div class="row leftLine">
                    <div class="col-xs-3">收件人：</div>
                    <div class="col-xs-3 rightTxt">{{o.delivery_to}}</div>
                    <div class="col-xs-3">收件电话：</div>
                    <div class="col-xs-3 rightTxt">{{o.delivery_tel}}</div>
                </div>
                <div class="row leftLine">
                    <div class="col-xs-3">收件省市：</div>
                    <div class="col-xs-9 rightTxt">--</div>
                </div>
                <div class="row leftLine">
                    <div class="col-xs-3">详细地址：</div>
                    <div class="col-xs-9 rightTxt">--</div>
                </div>
                <div class="row leftLine">
                    <div class="col-xs-3">分享保单：<Br>含地址</div>
                    <div class="col-xs-6 rightTxt">
                        <textarea id="contents" class="form-control">www.520czj.com/user/showInsurance/{{poid}}</textarea>

                    </div>
                    <div class="col-xs-3"><input type="button" onClick="jsCopy2();" class="btn btn-outline btn-primary btn-xs" value="复制"/></div>
                </div>
                <div class="row leftLine">
                    <div class="col-xs-3">分享保单：<Br>无地址</div>
                    <div class="col-xs-6 rightTxt">
                        <textarea id="contents_without_add" class="form-control">www.520czj.com/user/showInsurance/{{poid2}}?addr=1</textarea>

                    </div>
                    <div class="col-xs-3"><input type="button" onClick="jsCopy();" class="btn btn-outline btn-primary btn-xs" value="复制"/></div>
                </div>
                <div class="row leftLine">
                    <div class="col-xs-3">取消订单：</div>
                    <div class="col-xs-6 rightTxt">
                        <textarea class="form-control" id="cancel_cause" placeholder="订单取消原因...">{{o.cancel_reason}}</textarea>
                    </div>
                    <div class="col-xs-3"><input type="button" data-id="{{o.id}}" id="btnCancel" class="btn btn-outline btn-primary btn-xs" value="取消订单"></div>
                </div>
                <div class="row leftLine">
                    <div class="col-xs-3">本地备注：</div>
                    <div class="col-xs-6 rightTxt">
                        <textarea class="form-control" id="summary" placeholder="添加本地备注...">{{o.cancelreason}}</textarea>
                    </div>
                    <div class="col-xs-3"><input type="button" data-id="{{o.id}}" class="btn btn-outline btn-primary btn-xs" value="本地备注" ></div>
                </div>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-sm-12 col-md-6">
        <div class="panel panel-primary">
            <div class="panel-body" data-am-widget="gallery"  data-am-gallery="{ pureview: true }">

                    <h4>图片信息
                    <input type="button" class="btn btn-outline btn-primary btn-xs" onclick="imgocr({{ o.id }})" value="OCR"/>
                        <input type="button" class="btn btn-outline btn-primary btn-xs" value="保存"/>
                    </h4>

                <div class="row">
                    <div class="col-xs-6" style="text-align: center">
                        <a href="{{o.id_card_front}}" class="">
                            <img style="width:160px; height:110px;" src="{{o.id_card_front}}"/>
                        </a>
                        <div>
                            <input type="button" {% if o.icfstatus==1 %} class="btn btn-outline btn-warning btn-xs" value="取消重新上传"
                                   {% else %} class="btn btn-outline btn-primary btn-xs" value="重新上传" {% endif %}/>
                        </div>
                    </div>
                    <div class="col-xs-6" style="text-align: center">
                        <a href="{{o.id_card_back}}" class="">
                            <img style="width:160px; height:110px;" src="{{o.id_card_back}}"/>
                        </a>
                        <div>
                            <input type="button" {% if o.icbstatus==1 %} class="btn btn-outline btn-warning btn-xs" value="取消重新上传"
                                   {% else %} class="btn btn-outline btn-primary btn-xs" value="重新上传" {% endif %}/>
                        </div>
                    </div>
                </div>
                <div class="row" style="margin-top: 5px;">
                    <div class="col-xs-6" style="text-align: center">
                        <a href="{{o.drive_card_front}}" class="">
                            <img style="width:160px; height:110px;" src="{{o.drive_card_front}}"/>
                        </a>
                        <div>
                            <input type="button" {% if o.dcfstatus==1 %} class="btn btn-outline btn-warning btn-xs" value="取消重新上传"
                                   {% else %} class="btn btn-outline btn-primary btn-xs" value="重新上传" {% endif %}/>
                        </div>
                    </div>
                    <div class="col-xs-6" style="text-align: center">
                        <a href="{{o.drive_card_back}}" class="">
                            <img style="width:160px; height:110px;" src="{{o.drive_card_back}}"/>
                        </a>
                        <div>
                            <input type="button" {% if o.dcbstatus==1 %} class="btn btn-outline btn-warning btn-xs" value="取消重新上传"
                                   {% else %} class="btn btn-outline btn-primary btn-xs" value="重新上传" {% endif %}/>
                        </div>
                    </div>
                </div>
                <input type="checkbox" {% if o.is_same_person==1 %} checked="checked" {% endif %}
                       onchange="check_one_people()" style="visibility: visible;">车主同被保险人
                <div class="row" style="margin-top: 5px; {% if o.is_same_person==1 %} display: none {% endif %}" id="is_same_person">
                    <div class="col-xs-6" style="text-align: center">
                        <a href="{{o.id_card_front_owner}}" class="">
                            <img style="width:160px; height:110px;" src="{{o.id_card_front_owner}}"/>
                        </a>
                        <div>
                            <input type="button" {% if o.icfostatus==1 %} class="btn btn-outline btn-warning btn-xs" value="取消重新上传"
                                   {% else %} class="btn btn-outline btn-primary btn-xs" value="重新上传" {% endif %}/>
                        </div>
                    </div>
                    <div class="col-xs-6" style="text-align: center">
                        <a href="{{o.id_card_back_owner}}" class="">
                            <img style="width:160px; height:110px;" src="{{o.id_card_back_owner}}"/>
                        </a>
                        <div>
                            <input type="button" {% if o.icbostatus==1 %} class="btn btn-outline btn-warning btn-xs" value="取消重新上传"
                                   {% else %} class="btn btn-outline btn-primary btn-xs" value="重新上传" {% endif %}/>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xs-3">
                        姓名
                    </div>
                    <div class="col-xs-3 rightTxt">
                        <input id="ocr_name" class="form-control" type="text" />
                    </div>
                    <div class="col-xs-3">
                        到期时间
                    </div>
                    <div class="col-xs-3 rightTxt">
                        <input id="ocr_end_date" class="form-control" type="text" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-3">
                        身份证号
                    </div>
                    <div class="col-xs-9 rightTxt">
                        <input id="ocr_num" class="form-control" type="text" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-3">
                        地址
                    </div>
                    <div class="col-xs-9 rightTxt">
                        <input id="ocr_address" class="form-control" type="text" />
                    </div>
                </div>
                <div class="row">

                </div>
                <div class="row">
                    <div class="col-xs-3">
                        车牌号
                    </div>
                    <div class="col-xs-3 rightTxt">
                        <input id="ocr_plate_num" class="form-control" type="text" />
                    </div>
                    <div class="col-xs-3">
                        发动机号
                    </div>
                    <div class="col-xs-3 rightTxt">
                        <input id="ocr_engine_num" class="form-control" type="text" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-3">
                        能源类型
                    </div>
                    <div class="col-xs-3 rightTxt">
                        <select name="fuel_type" class="form-control">
                            {% for k,v in fuel_type.items() %}
                            <option value="{{k}}">{{v}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-xs-3">
                        拥有人类型
                    </div>
                    <div class="col-xs-3 rightTxt">
                        <select name="owner_type" class="form-control">
                            {% for k,v in owner_type.items() %}
                            <option value="{{k}}">{{v}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-3">
                        品牌型号
                    </div>
                    <div class="col-xs-3 rightTxt">
                        <input id="pinpai_model" class="form-control" type="text" />
                    </div>
                    <div class="col-xs-3">
                        细化型号
                    </div>
                    <div class="col-xs-3 rightTxt">
                        <select name="detail_type" class="form-control">

                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-3">
                        车架号
                    </div>
                    <div class="col-xs-9 rightTxt">
                        <input id="ocr_vin" class="form-control" type="text" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-3">
                        车型
                    </div>
                    <div class="col-xs-9 rightTxt">
                        <input id="ocr_vehicle_type" class="form-control" type="text" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-3">
                        座位数
                    </div>
                    <div class="col-xs-3 rightTxt">
                        <input class="form-control" type="text" />
                    </div>
                    <div class="col-xs-3">
                        整备质量
                    </div>
                    <div class="col-xs-3 rightTxt">
                        <input class="form-control" type="text" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-3">
                        抢险起保日期
                    </div>
                    <div class="col-xs-3 rightTxt">
                        <input class="form-control" type="text" />
                    </div>
                    <div class="col-xs-3">
                        商业险起保日期
                    </div>
                    <div class="col-xs-3 rightTxt">
                        <input class="form-control" type="text" />
                    </div>
                </div>
                <!-- 中华联合补充材料 -->
                <div class="row">
                    <div class="col-xs-3">
                        交管所车辆类型
                    </div>
                    <div class="col-xs-3 rightTxt">
                        <select name="rta_type" class="form-control">
                            {% for k,v in rta_type.items() %}
                            <option value="{{k}}">{{v}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-xs-3">
                        细化车辆类型
                    </div>
                    <div class="col-xs-3 rightTxt">
                        <select name="car_detail_type" class="form-control">
                            {% for k,v in car_detail_type.items() %}
                            <option value="{{k}}">{{v}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-3">
                        车牌类型
                    </div>
                    <div class="col-xs-3 rightTxt">
                        <select name="car_number_type" class="form-control">
                            {% for k,v in car_number_type.items() %}
                            <option value="{{k}}">{{v}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-xs-3">
                        行驶证类型
                    </div>
                    <div class="col-xs-3 rightTxt">
                        <select name="license_type" class="form-control">
                            {% for k,v in license_type.items() %}
                            <option value="{{k}}">{{v}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-12 col-md-12">
        <div class="panel panel-primary">
            <div class="panel-body">
                <h4>报价信息
                    <input onclick="new_program({{o.id}})" type="button" class="btn btn-outline btn-primary btn-xs" value="新报价"/>
                </h4>
                {% for program in programs %}
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>提交时间</th>
                            <th>保险公司</th>
                            <th>交强险</th>
                            <th>商业险</th>
                            <th>返佣情况</th>
                            <th>状态</th>
                            <th>处理人</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>{{program['pid']}}</td>
                            <td>{{ program['created'] | datetimeformat }}</td>
                            <td>{{program['insurance'].name}}</td>
                            <td>{{program['force_price']}}</td>
                            <td>{{program['business_price']}}</td>
                            <td>{% if 1 == program['gift_policy'] %} 返油
                                {% elif 2 == program['gift_policy'] %} 返现
                                {% else %} 其它 {% endif %}
                            </td>
                            <td>
                                {% if program['response'] == 0 %}
                                待报价
                                {% elif program['response'] == 1 %}
                                已报价
                                {% else %}
                                支付完成
                                {% endif %}
                            </td>
                            <td>{{program['admin_user']}}</td>
                            <td><a href="#" onclick="openShutManager(this, {{program['pid']}})" style="font-size: 22px; color:black;">+</a></td>
                        </tr>
                        <tr id="{{program['pid']}}" style="display: none">
                            <td colspan="9">
                                <div class="col-sm-12 col-md-12">
                                    <div class="panel panel-success">
                                        <div class="panel-heading">
                                            <div class="panel-title">
                                                <div class="row">
                                                    <div class="col-xs-6" style="line-height: 34px;">购买险种</div>
                                                    <div class="col-xs-6">
                                                        <div class="row">
                                                            <div class="col-xs-4" style="line-height: 34px; text-align: right;">保险公司:</div>
                                                            <div class="col-xs-8 rightTxt">
                                                                <select name="insurance" class="form-control">
                                                                    {% for p in insurances %}
                                                                    <option value="{{p.id}}" {{p.name == program['insurance'].name and "selected" or ''}}>{{p.name}}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="panel-body" style="padding: 0;">
                                            <table class="table table-bordered" style="width:100%;">
                                                <tbody>
                                                <tr>
                                                    <td>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>
                                                                    <input type="checkbox" {% if program['program'][0]['value'] %} checked="checked" {% endif %} onclick="ck_box('00_', {{program['pid']}})" style="visibility: visible;">交强险
                                                                </label>
                                                                <span style="color:#438bca;cursor:pointer;">--</span>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" id="00_{{program['pid']}}" {% if not program['program'][0]['value'] %} disabled="disabled" {% endif %} class="form-control" name="forceIPrice" value="{{program['program'][0]['price']}}">
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>
                                                                    <input type="checkbox" {% if program['program'][0]['value'] %} checked="checked" {% endif %} onclick="ck_box('000_', {{program['pid']}})" style="visibility: visible;">车船税
                                                                </label>
                                                                <span style="color:#438bca;cursor:pointer;">--</span>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" id="000_{{program['pid']}}" {% if not program['program'][0]['value'] %} disabled="disabled"{% endif %} class="form-control" name="vehicle_tax_price" value="{{program['vehicle_tax_price']}}">
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>
                                                                    <input type="checkbox" {% if program['program'][1]['value'] %} checked="checked" {% endif %} onclick="ck_box('01_', {{program['pid']}})" style="visibility: visible;">车损险
                                                                </label>
                                                                <span style="color:#438bca;cursor:pointer;">--</span>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" id="01_{{program['pid']}}" {% if not program['program'][1]['value'] %} disabled="disabled" {% endif %} class="form-control" name="damageIPrice" value="{{program['program'][1]['price']}}" >
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>
                                                                    <input type="checkbox" {% if program['program'][2]['value'] %} checked="checked" {% endif %} onclick="ck_box('02_', {{program['pid']}})" style="visibility: visible;">不计免赔
                                                                </label>
                                                                <span style="color:#438bca;cursor:pointer;">--</span>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" id="02_{{program['pid']}}" {% if not program['program'][2]['value'] %} disabled="disabled" {% endif %} class="form-control" name="damageIPlusPrice" value="{{program['program'][2]['price']}}">
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>
                                                                    <input type="checkbox" {% if program['program'][3]['value'] %} checked="checked" {% endif %} onclick="ck_box('03_', {{program['pid']}})" style="visibility: visible;">三责险
                                                                </label>
                                                                <span style="color:#438bca;cursor:pointer;">
                                                                <select name="insurance">
                                                                    {% for iip in program['program'][3]['i_item_price'] %}
                                                                    <option value="{{iip.id}}" {% if not program['program'][3]['value'] %} disabled="disabled" {% endif %} {{ iip['coverage'] == program['program'][3]['value'] and "selected" or '' }}>{{iip['coverage']}}</option>
                                                                    {% endfor %}
                                                                </select>
                                                                </span>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" id="03_{{program['pid']}}" class="form-control" name="thirdDutyIPrice" value="{{program['program'][3]['price']}}">
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>
                                                                    <input type="checkbox" {% if program['program'][4]['value'] %} checked="checked" {% endif %} onclick="ck_box('04_', {{program['pid']}})" style="visibility: visible;">不计免赔
                                                                </label>
                                                                <span style="color:#438bca;cursor:pointer;">--</span>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" id="04_{{program['pid']}}" {% if not program['program'][4]['value'] %} disabled="disabled" {% endif %} class="form-control" name="thirdDutyIPlusPrice" value="{{program['program'][4]['price']}}">
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>
                                                                    <input type="checkbox" {% if program['program'][5]['value'] %} checked="checked" {% endif %} onclick="ck_box('05_', {{program['pid']}})" style="visibility: visible;">全车盗抢险
                                                                </label>
                                                                <span style="color:#438bca;cursor:pointer;">--</span>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" id="05_{{program['pid']}}" {% if not program['program'][5]['value'] %} disabled="disabled" {% endif %} class="form-control" name="robbingIPrice" value="{{program['program'][5]['price']}}">
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>
                                                                    <input type="checkbox" {% if program['program'][6]['value'] %} checked="checked" {% endif %} onclick="ck_box('06_', {{program['pid']}})" style="visibility: visible;">不计免赔
                                                                </label>
                                                                <span style="color:#438bca;cursor:pointer;">--</span>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" id="06_{{program['pid']}}" {% if not program['program'][6]['value'] %} disabled="disabled" {% endif %} class="form-control" name="robbingIPlusPrice" value="{{program['program'][6]['price']}}">
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>
                                                                    <input type="checkbox" {% if program['program'][7]['value'] %} checked="checked" {% endif %} onclick="ck_box('07_', {{program['pid']}})" style="visibility: visible;">车上人司机
                                                                </label>
                                                                <span style="color:#438bca;cursor:pointer;">
                                                                <select name="insurance">
                                                                    {% for iip in program['program'][7]['i_item_price'] %}
                                                                    <option value="{{iip.id}}" {{ iip['coverage'] == program['program'][7]['value'] and "selected" or '' }}>{{iip['coverage']}}</option>
                                                                    {% endfor %}
                                                                </select>
                                                                </span>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" id="07_{{program['pid']}}" class="form-control" name="driverDutyIPrice" {% if not program['program'][7]['value'] %} disabled="disabled" {% endif %} value="{{program['program'][7]['price']}}">
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>
                                                                    <input type="checkbox" {% if program['program'][8]['value'] %} checked="checked" {% endif %} onclick="ck_box('08_', {{program['pid']}})" style="visibility: visible;">不计免赔
                                                                </label>
                                                                <span style="color:#438bca;cursor:pointer;">--</span>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" id="08_{{program['pid']}}" {% if not program['program'][8]['value'] %} disabled="disabled" {% endif %} class="form-control" name="driverDutyIPlusPrice" value="{{program['program'][8]['price']}}">
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>
                                                                    <input type="checkbox" {% if program['program'][9]['value'] %} checked="checked" {% endif %} onclick="ck_box('09_', {{program['pid']}})" style="visibility: visible;">车上人乘客
                                                                </label>
                                                                <span style="color:#438bca;cursor:pointer;">
                                                                <select name="insurance">
                                                                    {% for iip in program['program'][9]['i_item_price'] %}
                                                                    <option value="{{iip.id}}" {{ iip['coverage'] == program['program'][9]['value'] and "selected" or '' }}>{{iip['coverage']}}</option>
                                                                    {% endfor %}
                                                                </select>
                                                                </span>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" id="09_{{program['pid']}}" class="form-control" {% if not program['program'][9]['value'] %} disabled="disabled" {% endif %} name="passengerDutyIPrice" value="{{program['program'][9]['price']}}">
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>
                                                                    <input type="checkbox" {% if program['program'][10]['value'] %} checked="checked" {% endif %} onclick="ck_box('10_', {{program['pid']}})" style="visibility: visible;">不计免赔
                                                                </label>
                                                                <span style="color:#438bca;cursor:pointer;">--</span>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" id="10_{{program['pid']}}" {% if not program['program'][10]['value'] %} disabled="disabled" {% endif %} class="form-control" name="passengerDutyIPlusPrice" value="{{program['program'][10]['price']}}">
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>
                                                                    <input type="checkbox" {% if program['program'][11]['value'] %} checked="checked" {% endif %} onclick="ck_box('11_', {{program['pid']}})" style="visibility: visible;">单独玻璃破碎险
                                                                </label>
                                                                <span style="color:#438bca;cursor:pointer;">--</span>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" id="11_{{program['pid']}}" {% if not program['program'][11]['value'] %} disabled="disabled" {% endif %} class="form-control" name="glassIPrice" value="{{program['program'][11]['price']}}">
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>
                                                                    <input type="checkbox" {% if program['program'][12]['value'] %} checked="checked" {% endif %} onclick="ck_box('12_', {{program['pid']}})" style="visibility: visible;">车身划痕险
                                                                </label>
                                                                <span style="color:#438bca;cursor:pointer;">
                                                                <select name="insurance">
                                                                    {% for iip in program['program'][12]['i_item_price'] %}
                                                                    <option value="{{iip.id}}" {{ iip['coverage'] == program['program'][12]['value'] and "selected" or '' }}>{{iip['coverage']}}</option>
                                                                    {% endfor %}
                                                                </select>
                                                                </span>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" id="12_{{program['pid']}}" {% if not program['program'][12]['value'] %} disabled="disabled" {% endif %} class="form-control" name="scratchIPrice" value="{{program['program'][12]['price']}}">
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>
                                                                    <input type="checkbox" {% if program['program'][13]['value'] %} checked="checked" {% endif %} onclick="ck_box('13_', {{program['pid']}})" style="visibility: visible;">不计免赔
                                                                </label>
                                                                <span style="color:#438bca;cursor:pointer;">--</span>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" id="13_{{program['pid']}}" {% if not program['program'][13]['value'] %} disabled="disabled" {% endif %} class="form-control" name="scratchIPlusPrice" value="{{program['program'][13]['price']}}">
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>
                                                                    <input type="checkbox" {% if program['program'][14]['value'] %} checked="checked" {% endif %} onclick="ck_box('14_', {{program['pid']}})" style="visibility: visible;">自燃损失险
                                                                </label>
                                                                <span style="color:#438bca;cursor:pointer;">--</span>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" id="14_{{program['pid']}}" {% if not program['program'][14]['value'] %} disabled="disabled" {% endif %} class="form-control" name="fireDamageIPrice" value="{{program['program'][14]['price']}}">
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>
                                                                    <input type="checkbox" {% if program['program'][15]['value'] %} checked="checked" {% endif %} onclick="ck_box('15_', {{program['pid']}})" style="visibility: visible;">不计免赔
                                                                </label>
                                                                <span style="color:#438bca;cursor:pointer;">--</span>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" id="15_{{program['pid']}}" {% if not program['program'][15]['value'] %} disabled="disabled" {% endif %} class="form-control" name="fireDamageIPlusPrice" value="{{program['program'][15]['price']}}">
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>
                                                                    <input type="checkbox" {% if program['program'][16]['value'] %} checked="checked" {% endif %} onclick="ck_box('16_', {{program['pid']}})" style="visibility: visible;">发动机涉水险
                                                                </label>
                                                                <span style="color:#438bca;cursor:pointer;">--</span>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" id="16_{{program['pid']}}" {% if not program['program'][16]['value'] %} disabled="disabled" {% endif %} class="form-control" name="wadeIPrice" value="{{program['program'][16]['price']}}">
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>
                                                                    <input type="checkbox" {% if program['program'][17]['value'] %} checked="checked" {% endif %} onclick="ck_box('17_', {{program['pid']}})" style="visibility: visible;">不计免赔
                                                                </label>
                                                                <span style="color:#438bca;cursor:pointer;">--</span>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" id="17_{{program['pid']}}" {% if not program['program'][17]['value'] %} disabled="disabled" {% endif %} class="form-control" name="wadeIPlusPrice" value="{{program['program'][17]['price']}}">
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>
                                                                    <input type="checkbox" {% if program['program'][18]['value'] %} checked="checked" {% endif %} onclick="ck_box('18_', {{program['pid']}})" style="visibility: visible;">无法找到第三方险
                                                                </label>
                                                                <span style="color:#438bca;cursor:pointer;">--</span>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" id="18_{{program['pid']}}" {% if not program['program'][18]['value'] %} disabled="disabled" {% endif %} class="form-control" name="thirdSpecialIPrice" value="{{program['program'][18]['price']}}">
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>交强险折扣</label>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" class="form-control" name="force_rate" value="{{program['force_rate']}}">
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>商业险折扣</label>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" class="form-control" name="business_rate" value="{{program['business_rate']}}">
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>商业总额</label>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" class="form-control" name="business_price" value="">
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="checkbox col-xs-8 leftTxt">
                                                                <label>保单总额</label>
                                                            </div>
                                                            <div class="col-xs-4 rightTxt">
                                                                <input type="text" class="form-control" name="insurance_price" value="">
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <input type="button" class="btn btn-outline btn-primary btn-xs" onclick="input_check({{ program['pid'] }}, 'check')" value="输入验证"/>
                                                        <input type="button" class="btn btn-outline btn-primary btn-xs" value="保险接口调用"/>
                                                        <input type="button" class="btn btn-outline btn-primary btn-xs" onclick="get_json({{program['pid']}})" value="快速录入"/>
                                                    </td>
                                                    <td>
                                                        <span name="check_result" style="font-size: 25px; color:red;"></span>
                                                    </td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div></div>
                                <div class="col-sm-6 col-md-6">
                                    <div class="panel panel-success">
                                        <div class="panel-heading">
                                            <div class="panel-title">
                                                <div class="row">
                                                    <div class="col-xs-5" style="line-height: 34px;">返佣信息</div>
                                                    <div class="col-xs-7">
                                                        <div class="row">
                                                            <div class="col-xs-5" style="line-height: 34px; text-align: right;">
                                                                返佣类型:</div>
                                                            <div class="col-xs-7 rightTxt">
                                                                <select id="gift_policy" name="gift_policy" onchange="get_gift_policy({{ program['pid'] }}, this.value)" class="form-control">
                                                                    <option value="1" {{ 1 == program['gift_policy'] and "selected" or '' }}>返油</option>
                                                                    <option value="2" {{ 2 == program['gift_policy'] and "selected" or '' }}>返现</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="panel-body">
                                            <table>
                                                <tbody id="{{program['pid']}}2" {% if 2 != program['gift_policy'] %}  style="display: none" {% endif %}>
                                                <tr>
                                                    <td>商业返佣率：<input name="business_s" value="" style="width: 100px;"/></td>
                                                    <td>交强返佣率：<input name="force_s" value="" style="width: 100px;"/></td>
                                                </tr>
                                                <tr>
                                                    <td>商业税率：<input name="business_tax" value="" style="width: 100px;"/></td>
                                                    <td>交强税率：<input name="force_tax" value="" style="width: 100px;"/></td>
                                                </tr>
                                                <tr>
                                                    <td>转账费率：<input name="ali_rate" value="" style="width: 80px;"/></td>
                                                    <td>起兑金额：<input name="base_money" value="" style="width: 100px;"/></td>
                                                </tr>
                                                <tr>
                                                    <td>获利率：<input name="profit" value="" style="width: 100px;"/></td>
                                                    <td style="color:#B94FFF;">返点：<input name="cash" value="{{program['cash']}}" style="width: 80px;"/></td>
                                                </tr>
                                                </tbody>
                                                <tbody  id="{{program['pid']}}1" {% if 1 != program['gift_policy'] %}  style="display: none" {% endif %}>
                                                <tr>
                                                    <td style="color:#008866;">车主油品：<input name="driveroiltype" value="" style="width: 100px;"/></td>
                                                    <td style="color:#008866;">车主数量：<input name="driveroilnum" value="" style="width: 100px;"/></td>
                                                </tr>
                                                <tr>
                                                    <td style="color:#008866;">门店油品：<input name="storeoiltype" value="" style="width: 80px;"/></td>
                                                    <td style="color:#008866;">门店数量：<input name="storeoilnum" value="" style="width: 80px;"/></td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6 col-md-6">
                                    <div class="panel panel-success">
                                        <div class="panel-heading">
                                            <div class="panel-title">
                                                <div class="row">
                                                    <div class="col-xs-5" style="line-height: 34px;">操作</div>
                                                    <div class="col-xs-7" style="line-height: 34px; text-align: right;">
                                                        <input type="button" onclick="input_check({{ program['pid'] }}, 'msg')" class="btn btn-outline btn-primary btn-xs" value="自动生成返佣与短信"/>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="panel-body">
                                            <div class="row">
                                                <div class="col-xs-12">
                                                    <textarea class="form-control" name="psummary" cols=50%; rows="10" placeholder="短信内容"></textarea>
                                                </div>
                                                <div class="col-xs-12" style="margin-top: 6px;">
                                                    <span onclick="saveData(1, 0)" style="padding:5px 10px;background:#438bca;color:#fff;border-radius:4px;font-size:14px;cursor:pointer;">保存</span>
                                                    <span onclick="saveData(1, 1)" style="padding:5px 10px;margin-top:3px;background:#438bca;color:#fff;border-radius:4px;font-size:14px;cursor:pointer;">保存并发短信</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div></div>
                                <div class="col-sm-12 col-md-12">
                                    <div class="panel panel-success">
                                        <div class="panel-heading">
                                            <h3 class="panel-title">补退款</h3>
                                        </div>
                                        <div class="panel-body">
                                            <div class="row" style="padding: 0 5px;">
                                                <div class="col-xs-6" style="padding: 0 20px;">
                                                    <div class="row">
                                                        <textarea id="ar_reason" name="ar_reason" value="{{program['append_refund_reason']}}" class="form-control" cols=50%; rows="4" placeholder="原因">{{program['append_refund_reason']}}</textarea>
                                                    </div>
                                                </div>
                                                <div class="col-xs-6" style="padding: 0 20px;">
                                                    <div class="row">
                                                        <div class="col-xs-6 leftTxt" style="text-align: right; line-height: 32px; ">补/退款金额：</div>
                                                        <div class="col-xs-6"><input id="ar_num" name="append_refund_num" value="{{program['append_refund_num']}}" type="text" class="form-control" ></div>
                                                    </div>
                                                    <div class="row" style="color:#567656; font-size:13px; padding-right: 13px; padding-bottom: 10px; text-align: right;">用户补款为正，给用户退款为负；退款进入用户余额</div>
                                                    <div class="row" style="text-align: right;padding-right: 13px; ">
                                                        <input onclick="append_refund_money({{program['pid']}}, {{program['append_refund_status']}})" type="button" class="btn btn-primary btn-sm" value="补退款"/>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
<div id="json_pop" style="display: none; padding: 10px;">
    <div>
        <textarea class="form-control" id="json_txt" rows="10" placeholder="请输入报价结果json..."></textarea>
    </div>
    <input type="hidden" id="hdpid">
    <div style="text-align: right; padding: 10px;">
    <input type="button" class="btn  btn-primary btn-sm"  value="保存" onclick="fastPrice()">
        <input type="button" class="btn btn-primary btn-sm"  value="取消" onclick="javascript:layer.closeAll();">
    </div>
</div>
{% endblock %}


{% block js %}
<script src="/style/js/amazeui.js"></script>
<script src="/style/js/layer-v1.9/layer.js" type="text/javascript"></script>
<script>
//    $(document).ready(function() {
//
//    });
    var xsrf='{{handler.xsrf_token}}';
    function check_one_people(){
        var targetObj = document.getElementById('is_same_person');
        if(targetObj.style.display!="none"){
            targetObj.style.display="none";
        } else {
            targetObj.style.display="";
        }
    }

    function get_json(program_id) {
        $('#hdpid').val(program_id);
        $('#json_txt').val('');
        layer.open({
            type: 1,
            shadeClose: true,
            shade: 0.8,
            area: ['60%', '60%'],
            title: '报价快速录入', //不显示标题
            content: $('#json_pop')
        });
    }
    function fastPrice() {
        var program_id = $('#hdpid').val();
        var result_json = $('#json_txt').val();
        var str = JSON.parse(result_json);
        if (result_json != null && str != null ){
            var program = document.getElementById(program_id);
            $(program).find('input[name="business_price"]').val(str["businessI"]);  // 商业险总额
            $(program).find('input[name="business_rate"]').val(str["businessZK"]);    // 商业险折扣
            $(program).find('input[name="forceIPrice"]').val(str["forceI"]);    // 交强
            $(program).find('input[name="force_rate"]').val(str["forceZK"]);    // 交强险折扣
            $(program).find('input[name="damageIPrice"]').val(str["damageI"]);    // 车辆损失
            $(program).find('input[name="damageIPlusPrice"]').val(str["damageIPlus"]);    // 车损不计免赔
            $(program).find('input[name="thirdDutyIPrice"]').val(str["thirdDutyI"]);    // 三责
            $(program).find('input[name="thirdDutyIPlusPrice"]').val(str["thirdDutyIPlus"]);    // 三责不计免赔
            $(program).find('input[name="robbingIPrice"]').val(str["robbingI"]);    // 盗抢
            $(program).find('input[name="robbingIPlusPrice"]').val(str["robbingIPlus"]);    // 盗抢免责
            $(program).find('input[name="driverDutyIPrice"]').val(str["driverDutyI"]);    // 车上司机
            $(program).find('input[name="driverDutyIPlusPrice"]').val(str["driverDutyIPlus"]);    // 车上司机免责
            $(program).find('input[name="passengerDutyIPrice"]').val(str["passengerDutyI"]);    // 车上乘客
            $(program).find('input[name="passengerDutyIPlusPrice"]').val(str["passengerDutyIPlus"]);    // 车上乘客免责
            $(program).find('input[name="glassIPrice"]').val(str["glassI"]);    // 玻璃
            $(program).find('input[name="scratchIPrice"]').val(str["scratchI"]);    // 划痕
            $(program).find('input[name="scratchIPlusPrice"]').val(str["scratchIPlus"]);    // 划痕免责
            $(program).find('input[name="fireDamageIPrice"]').val(str["fireDamageI"]);    // 自燃
            $(program).find('input[name="fireDamageIPlusPrice"]').val(str["fireDamageIPlus"]);    // 自燃免责
            $(program).find('input[name="wadeIPrice"]').val(str["wadeI"]);    // 涉水
            $(program).find('input[name="wadeIPlusPrice"]').val(str["wadeIPlus"]);    // 涉水免责
            $(program).find('input[name="thirdSpecialIPrice"]').val(str["thirdSpecialI"]);    // 跑路
            $(program).find('input[name="vehicle_tax_price"]').val(str["vehicle_tax_price"]);    // 车船税价格
            $(program).find('input[name="insurance_price"]').val(str["totalI"]);    // 保险总额
        }
        layer.closeAll();
    }

    function ck_box(i_item_p, id){
        var targetObj = document.getElementById(i_item_p+id);
        if(targetObj.disabled != true){
            targetObj.disabled = true;
        } else {
            targetObj.disabled = false;
        }
}

    // OCR function 调用ajax并回填识别信息
    function imgocr(id) {
        $.get('/ajax/ocr', {_xsrf:xsrf, io_id:id}, function (data) {
            var obj = jQuery.parseJSON(data);
            if (obj.flag == 1) {
                document.getElementById('ocr_name').value=obj.id_card_front.name;
                document.getElementById('ocr_address').value=obj.id_card_front.address;
                document.getElementById('ocr_num').value=obj.id_card_front.num;
                document.getElementById('ocr_end_date').value=obj.id_card_back.end_date;

                document.getElementById('ocr_plate_num').value=obj.drive_card_front.plate_num;
                document.getElementById('ocr_engine_num').value=obj.drive_card_front.engine_num;
                document.getElementById('ocr_vin').value=obj.drive_card_front.vin;
                document.getElementById('ocr_vehicle_type').value=obj.drive_card_front.vehicle_type;

            } else {
                alert(obj.msg);
            }
        });
    }

    // 选择返佣方式
    function change_gift_policy(pid, gift) {
        if(gift == 1){
            // 根据获取 ID 获取元素
            var program = document.getElementById(pid);
            // 获取数据
            var insurance = $(program).find('select[name="insurance"]').val();   // 保险 ID
            var gift_policy = $(program).find('select[name="gift_policy"]').val();   // 返佣方式

            var vehicle_tax_price = $(program).find('input[name="vehicle_tax_price"]').val();    // 车船税价格
            var total_force = 0;
            var total_business = 0;
            // 获取循环的险种数据
            $(program).find('table tr td').each(function (index, element) {
                var i_item_name = $(this).find('input[name="i_item"]').attr('c_name');
                var i_item = $(this).find('input[name="i_item"]').attr('e_name');
                var i_type = $(this).find('input[name="i_item"]').attr('i_type');
                var i_item_value = $(this).find('input[name="i_item"]').val();
                if(i_type == 1){
                    total_force = i_item_value;    // 交强险总金额
                }else if (i_type == 2 | i_type == 3){
                    total_business = total_business*1 + i_item_value*1;    // 商业险总金额
                }
            });
            // 回填
            $.get("/ajax/caculate_gift_oil", { _xsrf:xsrf, iopid:pid, insurance:insurance, business:total_business, force:total_force}, function (data) {
                var obj = jQuery.parseJSON(data);
                if (obj.flag == 1) {
                    $(program).find('input[name="driveroiltype"]').val(obj.data.driveroiltype);
                    $(program).find('input[name="driveroilnum"]').val(obj.data.driveroilnum);
                    $(program).find('input[name="storeoiltype"]').val(obj.data.storeoiltype);
                    $(program).find('input[name="storeoilnum"]').val(obj.data.storeoilnum);
                    $(program).find('input[name="cash"]').val(0);
                }
                else {
                    alert(obj.msg);
                }
                $(program).find('input[name="business_s"]').val(0);    // 商业险返佣率
                $(program).find('input[name="force_s"]').val(0);    // 交强险返佣率
                $(program).find('input[name="ali_rate"]').val(0);    // 转账费率
                $(program).find('input[name="profit"]').val(0);    // 利润率
                $(program).find('input[name="business_tax"]').val(0);    // 商业险税率
                $(program).find('input[name="force_tax"]').val(0);    // 交强险税率
                $(program).find('input[name="base_money"]').val(0);    // 起兑金额
            });
        } else if(gift == 2){
            var program = document.getElementById(pid);
            var iid = $(program).find('select[name="insurance"]').val();   // 获取保险公司ID

            $.get("/ajax/get_score_rate", {pid: pid, iid: iid}, function (data) {
                var obj = jQuery.parseJSON(data);
                if (obj.flag == 1) {
                    $(program).find('input[name="business_s"]').val(obj.data.business_s);    // 商业险返佣率
                    $(program).find('input[name="force_s"]').val(obj.data.force_s);    // 交强险返佣率
                    $(program).find('input[name="ali_rate"]').val(obj.data.ali_rate);    // 转账费率
                    $(program).find('input[name="profit"]').val(obj.data.profit_rate);    // 利润率
                    $(program).find('input[name="business_tax"]').val(obj.data.business_tax);    // 商业险税率
                    $(program).find('input[name="force_tax"]').val(obj.data.force_tax);    // 交强险税率
                    $(program).find('input[name="base_money"]').val(obj.data.base_money);    // 起兑金额
                    $(program).find('input[name="driveroiltype"]').val();
                    $(program).find('input[name="driveroilnum"]').val(0);
                    $(program).find('input[name="storeoiltype"]').val();
                    $(program).find('input[name="storeoilnum"]').val(0);
                }
                else {
                    alert(obj.msg);
                }
            });
        }

    }

    // 切换返佣方式
    function get_gift_policy(pid, gift) {
        var program = document.getElementById(pid);
        var iid = $(program).find('select[name="insurance"]').val();   // 保险 ID
        if(gift == 1){    // 返油
            // 根据获取 ID 获取元素
            var forceIPrice = $(program).find('input[name="forceIPrice"]').val();    // 交强
            var business_price = $(program).find('input[name="business_price"]').val();    // 商业险总额
            document.getElementById(pid+'1').style.display="";
            document.getElementById(pid+'2').style.display="none";
            console.debug(forceIPrice*1, business_price*1, iid);
            // 获取数据
            $.get("/ajax/caculate_gift_oil", { _xsrf:xsrf, iopid:pid, insurance:iid, business:business_price, force:forceIPrice}, function (data) {
                var obj = jQuery.parseJSON(data);
                if (obj.flag == 1) {
                    $(program).find('input[name="driveroiltype"]').val(obj.data.driveroiltype);
                    $(program).find('input[name="driveroilnum"]').val(obj.data.driveroilnum);
                    $(program).find('input[name="storeoiltype"]').val(obj.data.storeoiltype);
                    $(program).find('input[name="storeoilnum"]').val(obj.data.storeoilnum);
                    $(program).find('input[name="cash"]').val(0);
                }
                else {
                    alert(obj.msg);
                }
            });
        } else if(gift == 2){    // 返现
            document.getElementById(pid+'1').style.display="none";
            document.getElementById(pid+'2').style.display="";
            $.get("/ajax/get_score_rate", {pid: pid, iid: iid}, function (data) {
                var obj = jQuery.parseJSON(data);
                if (obj.flag == 1) {
                    $(program).find('input[name="business_s"]').val(obj.data.business_s);    // 商业险返佣率
                    $(program).find('input[name="force_s"]').val(obj.data.force_s);    // 交强险返佣率
                    $(program).find('input[name="ali_rate"]').val(obj.data.ali_rate);    // 转账费率
                    $(program).find('input[name="profit"]').val(obj.data.profit_rate);    // 利润率
                    $(program).find('input[name="business_tax"]').val(obj.data.business_tax);    // 商业险税率
                    $(program).find('input[name="force_tax"]').val(obj.data.force_tax);    // 交强险税率
                    $(program).find('input[name="base_money"]').val(obj.data.base_money);    // 起兑金额
                }
                else {
                    alert(obj.msg);
                }
            });
        }
    }

    function pop(title, url) {
        layer.open({
            type: 2,
            title: title,
            shadeClose: true,
            shade: 0.8,
            area: ['90%', '90%'],
            content: url
        });
    }

    function GetSubAreas(parent_code, ddl_id, seleted_code) {
        if(parent_code.length == 0) {
            $("#city").html('');
            $("#city").append("<option value=''>--所有城市--</option>");
            $("#district").html('');
            $("#district").append("<option value=''>--所有区县--</option>");
            return;
        }
        $.get("/ajax/GetSubAreas", { pcode: parent_code,  t: Math.random() }, function (data) {
            data = jQuery.parseJSON(data);
            if(data.flag==1){
                $("#" + ddl_id).html('');
                if(parent_code.length == 4) {
                    $("#" + ddl_id).append("<option value=''>--所有城市--</option>");
                }
                else if (parent_code.length == 8) {
                    $("#" + ddl_id).append("<option value=''>--所有区县--</option>");
                }
                for(var i=0; i< data.data.length; i++){
                    if(data.data[i]["code"]==seleted_code){
                        $("#" + ddl_id).append("<option value=\"" + data.data[i]["code"] + "\" selected>" + data.data[i]["name"] + "</option>");
                    } else{
                        $("#" + ddl_id).append("<option value=\"" + data.data[i]["code"] + "\">" + data.data[i]["name"] + "</option>");
                    }
                }
            }
        });
    }

    // 取消订单
    $(function() {
        var xsrf='{{handler.xsrf_token}}';
        ids = [{{o.id}}];
        $("#btnCancel").click(function() {
            var oid = $(this).attr("data-id");
            console.debug(oid);
            var cause = $("#cancel_cause").val();
            if (cause != "") {
                layer.confirm("您确认要取消此订单吗？", {
                    btn: ['确认', '放弃'],
                    shade: 0.2
                },function () {
                    $.post("/ajax/cancel_insurance_order", {_xsrf: xsrf, oid: oid, cause: cause}, function (data) {
                        var result = jQuery.parseJSON(data);
                        if (result.flag == 1) {
                            layer.msg("取消成功！");
                            window.location.href="/admin/insurance_order/"+oid;
                        }
                        else {
                            layer.alert(result.msg)
                        }
                    });
                });
            }else{
                layer.alert("请输入取消原因！");
            }
        });
    });

    //检查是否是非数字值
    function checkNum(obj) {
        if (isNaN(obj.value)) {
            obj.value = "";
        }
        if (obj != null) {
            //检查小数点后是否对于两位http://blog.csdn.net/shanzhizi
            if (obj.value.toString().split(".").length > 1 && obj.value.toString().split(".")[1].length > 2) {
                alert("小数点后多于两位！");
                obj.value = "";
            }
        }
    }

    function jsCopy(){
        var txt = document.getElementById("contents");//对象是contents
        txt.select(); //选择对象
        tag=document.execCommand("Copy"); //执行浏览器复制命令
        if(tag){
            alert('复制内容成功');
        }
    }

    function jsCopy2(){
        var e=document.getElementById("contents_without_add");//对象是contents
        e.select(); //选择对象
        tag=document.execCommand("Copy"); //执行浏览器复制命令
        if(tag){
            alert('复制内容成功');
        }
    }

    function change_status(ordernum){
        var localsummary=document.getElementById("localsummary").value;
        $.post("/ajax/submit_local_summary", { _xsrf:xsrf, ordernum:ordernum, localsummary:localsummary}, function (data) {
            var obj = jQuery.parseJSON(data);
            if (obj.flag == 1) {
                alert('成功');
            }
            else {
                alert(obj.msg);
            }
        });
    }

    // 输入验证
    function input_check(program_id, operation){
        // 根据获取 ID 获取元素
        var program = document.getElementById(program_id);
        // 获取数据
        var forceIPrice = $(program).find('input[name="forceIPrice"]').val();    // 交强
        var vehicle_tax_price = $(program).find('input[name="vehicle_tax_price"]').val();    // 车船税价格
        var business_price = $(program).find('input[name="business_price"]').val();    // 商业险总额

        var damageIPrice = $(program).find('input[name="damageIPrice"]').val();    // 车辆损失
        var damageIPlusPrice = $(program).find('input[name="damageIPlusPrice"]').val();    // 车损不计免赔
        var thirdDutyIPrice = $(program).find('input[name="thirdDutyIPrice"]').val();    // 三责
        var thirdDutyIPlusPrice = $(program).find('input[name="thirdDutyIPlusPrice"]').val();    // 三责不计免赔
        var robbingIPrice = $(program).find('input[name="robbingIPrice"]').val();    // 盗抢
        var robbingIPlusPrice = $(program).find('input[name="robbingIPlusPrice"]').val();    // 盗抢免责
        var driverDutyIPrice = $(program).find('input[name="driverDutyIPrice"]').val();    // 车上司机
        var driverDutyIPlusPrice = $(program).find('input[name="driverDutyIPlusPrice"]').val();    // 车上司机免责
        var passengerDutyIPrice = $(program).find('input[name="passengerDutyIPrice"]').val();    // 车上乘客
        var passengerDutyIPlusPrice = $(program).find('input[name="passengerDutyIPlusPrice"]').val();    // 车上乘客免责

        var glassIPrice = $(program).find('input[name="glassIPrice"]').val();    // 玻璃
        var scratchIPrice = $(program).find('input[name="scratchIPrice"]').val();    // 划痕
        var scratchIPlusPrice = $(program).find('input[name="scratchIPlusPrice"]').val();    // 划痕免责
        var fireDamageIPrice = $(program).find('input[name="fireDamageIPrice"]').val();    // 自燃
        var fireDamageIPlusPrice = $(program).find('input[name="fireDamageIPlusPrice"]').val();    // 自燃免责
        var wadeIPrice = $(program).find('input[name="wadeIPrice"]').val();    // 涉水
        var wadeIPlusPrice = $(program).find('input[name="wadeIPlusPrice"]').val();    // 涉水免责
        var thirdSpecialIPrice = $(program).find('input[name="thirdSpecialIPrice"]').val();    // 跑路

        var insurance_price = $(program).find('input[name="insurance_price"]').val();    // 保险总额
        // 计算总额
        var total_business = damageIPrice*1+damageIPlusPrice*1+thirdDutyIPrice*1+thirdDutyIPlusPrice*1+robbingIPrice*1+
            robbingIPlusPrice*1+driverDutyIPrice*1+driverDutyIPlusPrice*1+passengerDutyIPrice*1+passengerDutyIPlusPrice*1+
            glassIPrice*1+scratchIPrice*1+scratchIPlusPrice*1+fireDamageIPrice*1+fireDamageIPlusPrice*1+wadeIPrice*1+
            wadeIPlusPrice*1+thirdSpecialIPrice*1;
        var total_price = forceIPrice*1 + total_business + vehicle_tax_price*1;
        // 回填
        if(business_price != total_business){
            $(program).find('span[name="check_result"]').text('商业险总额错误！');
        } else if (insurance_price != total_price){
            $(program).find('span[name="check_result"]').text('保险总额错误！');
        } else {
            $(program).find('span[name="check_result"]').text('正确！');
            var check = 1;
        }
        if(operation == "msg"){
            if(check == 1){
                var msg = '';
                var business_rate = $(program).find('input[name="business_rate"]').val();    // 商业险折扣
                var force_rate = $(program).find('input[name="force_rate"]').val();    // 交强险折扣
                if(business_rate == ''){
                    msg = '商业险'+total_business+'元\n'
                } else{
                    msg = '商业险'+business_rate+'折'+total_business+'元\n'
                }
                if(force_rate == ''){
                    msg = msg+'交强险'+forceIPrice+'元\n'
                } else {
                    msg = msg+'交强险'+force_rate+'折'+forceIPrice+'元\n'
                }
                msg = msg+'车船税'+vehicle_tax_price+'元\n' + '合计'+total_price+'元；\n'+'其中:';

                if(damageIPrice != ''){
                    msg = msg+'车辆损失险'+damageIPrice+'元\n'
                }
                if(damageIPlusPrice != ''){
                    msg = msg+'车辆损失不计免赔'+damageIPlusPrice+'元\n'
                }
                if(thirdDutyIPrice != ''){
                    msg = msg +'第三着责任险'+thirdDutyIPrice+'元\n'
                }
                if(thirdDutyIPlusPrice != ''){
                    msg = msg +'第三着责任不计免赔'+thirdDutyIPlusPrice+'元\n'
                }
                if( robbingIPrice != ''){
                    msg = msg +'盗抢险'+robbingIPrice+'元\n'
                }
                if(robbingIPlusPrice != ''){
                    msg = msg +'盗抢险不计免赔'+robbingIPlusPrice+'元\n'
                }
                if(driverDutyIPrice != ''){
                    msg = msg +'车上人员责任险（司机）'+driverDutyIPrice+'元\n'
                }
                if(driverDutyIPlusPrice != ''){
                    msg = msg +'车上人员责任险（司机）不计免赔'+driverDutyIPlusPrice+'元\n'
                }
                if(passengerDutyIPrice != ''){
                    msg = msg +'车上人员责任险（乘客）'+passengerDutyIPrice+'元\n'
                }
                if(passengerDutyIPlusPrice != ''){
                    msg = msg +'车上人员责任险（乘客）不计免赔'+passengerDutyIPlusPrice+'元\n'
                }
                if(glassIPrice != ''){
                    msg = msg +'玻璃单独破碎险'+glassIPrice+'元\n'
                }
                if(scratchIPrice != ''){
                    msg = msg +'车身划痕损失险'+scratchIPrice+'元\n'
                }
                if(scratchIPlusPrice != ''){
                    msg = msg +'车身划痕损失不计免赔'+scratchIPlusPrice+'元\n'
                }
                if(fireDamageIPrice != ''){
                    msg = msg +'自燃损失险'+fireDamageIPrice+'元\n'
                }
                if(fireDamageIPlusPrice != ''){
                    msg = msg +'自燃损失不计免赔'+fireDamageIPlusPrice+'元\n'
                }
                if(wadeIPrice != ''){
                    msg = msg +'发动机涉水损失险'+wadeIPrice+'元\n'
                }
                if(wadeIPlusPrice != ''){
                    msg = msg +'发动机涉水损失不计免赔'+wadeIPlusPrice+'元\n'
                }
                if(thirdSpecialIPrice != ''){
                    msg = msg +'车辆损失无法找到第三方特约险'+thirdSpecialIPrice+'元\n'
                }
                $(program).find('textarea[name="psummary"]').val(msg);

                var business_s = $(program).find('input[name="business_s"]').val();    // 商业险返佣率
                var force_s = $(program).find('input[name="force_s"]').val();    // 交强险返佣率
                var ali_rate = $(program).find('input[name="ali_rate"]').val();    // 转账费率
                var profit = $(program).find('input[name="profit"]').val();    // 利润率
                var business_tax = $(program).find('input[name="business_tax"]').val();    // 商业险税率
                var force_tax = $(program).find('input[name="force_tax"]').val();    // 交强险税率
                var cash = total_business*(1-business_tax/100)*business_s/100 + forceIPrice*(1-force_tax/100)*force_s/100 - total_price*(ali_rate/100+profit/100);
                $(program).find('input[name="cash"]').val(cash.toFixed(2));
            } else {
                alter('保险金额有误');
            }
        }
    }

    // 自动计算
    function auto_calculation(program_id){
        // 根据获取 ID 获取元素
        var program = document.getElementById(program_id);
        // 获取数据
        var insurance = $(program).find('select[name="insurance"]').val();   // 保险 ID
        var gift_policy = $(program).find('select[name="gift_policy"]').val();   // 返佣方式
        var vehicle_tax_price = $(program).find('input[name="vehicle_tax_price"]').val();    // 车船税价格
        var business_rate = $(program).find('input[name="business_rate"]').val();    // 商业险折扣
        if( business_rate == ''){
            business_rate = 10;
        }
        var force_rate = $(program).find('input[name="force_rate"]').val();    // 交强险折扣
        if( force_rate == ''){
            force_rate = 10;
        }
        var business_s = $(program).find('input[name="business_s"]').val();    // 商业险返佣率
        var force_s = $(program).find('input[name="force_s"]').val();    // 交强险返佣率
        var ali_rate = $(program).find('input[name="ali_rate"]').val();    // 转账费率
        var profit = $(program).find('input[name="profit"]').val();    // 利润率
        var business_tax = $(program).find('input[name="business_tax"]').val();    // 商业险税率
        var force_tax = $(program).find('input[name="force_tax"]').val();    // 交强险税率

        var total_force = 0;
        var total_business = 0;
        var insurance_details = '';
        // 获取循环的险种数据
        $(program).find('table tr td').each(function (index, element) {
            var i_item_name = $(this).find('input[name="i_item"]').attr('c_name');
            var i_item = $(this).find('input[name="i_item"]').attr('e_name');
            var i_type = $(this).find('input[name="i_item"]').attr('i_type');
            var i_item_value = $(this).find('input[name="i_item"]').val();
            if(i_type == 1){
                total_force = i_item_value*force_rate/10;    // 交强险总金额
                insurance_details = insurance_details+i_item_name+i_item_value+'元\n';
            }else if (i_type == 2 | i_type == 3){
                total_business = total_business*1 + i_item_value*1;    // 商业险总金额
                insurance_details = insurance_details+i_item_name+i_item_value+'元\n';
            }
        });
        // 计算总额
        total_business = (total_business*business_rate/10);
        var total_price = total_force + total_business + vehicle_tax_price*1;
        var cash = total_business*(1-business_tax/100)*business_s/100 + total_force*(1-force_tax/100)*force_s/100 - total_price*(ali_rate/100+profit/100);
        if(gift_policy == '2'){
            $(program).find('input[name="cash"]').val(cash.toFixed(2));
        } else {
            $(program).find('input[name="cash"]').val(0);
        }
        // 回填
        $(program).find('input[name="business_price"]').val(total_business.toFixed(2));
        $(program).find('input[name="force_price"]').val(total_force.toFixed(2));
        $(program).find('input[name="total_price"]').val(total_price.toFixed(2));
        var msg = '';
        if(business_rate == '10'){
            msg = '商业险'+total_business+'元\n'
        } else{
            msg = '商业险'+business_rate+'折'+total_business+'元\n'
        }
        if(force_rate == '10'){
            msg = msg+'交强险'+total_force+'元\n'
        } else {
            msg = msg+'交强险'+force_rate+'折'+total_force+'元\n'
        }
        msg = msg+'车船税'+vehicle_tax_price+'元\n' + '合计'+total_price+'元；\n'+'其中:'+insurance_details;
        $(program).find('textarea[name="psummary"]').val(msg);
    }

    // 保存
    function  saveData(program_id, send_msg) {
        // 根据获取 ID 获取元素
        var program = document.getElementById(program_id);
        // 获取数据
        var i_items = {};
        $(program).find('table tr td').each(function (index, element) {
            var i_item = $(this).find('input[name="i_item"]').attr('e_name');
            var i_type = $(this).find('input[name="i_item"]').attr('i_type');
            var i_item_value = $(this).find('input[name="i_item"]').val();
            if(i_type == 1 | i_type == 2 | i_type == 3){
                i_items[i_item] = i_item_value;
            }
        });

        var insurance = $(program).find('select[name="insurance"]').val();   // 保险 ID
        var gift_policy = $(program).find('select[name="gift_policy"]').val();   // 返佣方式
        var vehicle_tax_price = $(program).find('input[name="vehicle_tax_price"]').val();    // 车船税价格
        var business_price = $(program).find('input[name="business_price"]').val();    // 商业险价格
        var force_price = $(program).find('input[name="force_price"]').val();    // 交强险价格
        var total_price = $(program).find('input[name="total_price"]').val();    // 总价
        var cash = $(program).find('input[name="cash"]').val();    // 积分
        var psummary = $(program).find('textarea[name="psummary"]').val();    // 短信
        var last_program = $(program).find('input[name="last_program"]').val();    // 是否最终方案
        var force_rate = $(program).find('input[name="force_rate"]').val();    // 短信
        var business_rate = $(program).find('input[name="business_rate"]').val();    // 是否最终方案
        var groups = {};
        groups['pid'] = program_id;
        groups['insurance'] = insurance;
        groups['gift_policy'] = gift_policy;
        groups['vehicle_tax_price'] = vehicle_tax_price;
        groups['business_price'] = business_price;
        groups['force_price'] = force_price;
        groups['total_price'] = total_price;
        groups['force_rate'] = force_rate;
        groups['business_rate'] = business_rate;
        groups['cash'] = cash;
        groups['psummary'] = psummary;
        groups['last_program'] = last_program;
        $.post('/ajax/save_iop_data', {_xsrf:xsrf, i_items:JSON.stringify(i_items), groups:JSON.stringify(groups), send_msg:send_msg}, function (data) {
            var obj = jQuery.parseJSON(data);
            if (obj.flag == 1) {
                alert('保存成功!');
            } else {
                alert(obj.msg);
            }
        });
    }

    // 新方案
    function new_program(oid) {
//        var title = '新建方案';
//        var url = '/admin/new_program/' + oid;
//        pop(title, url);
        $.post('/ajax/new_program/'+oid, {_xsrf:xsrf}, function (data) {
            var obj = jQuery.parseJSON(data);
            if (obj.flag == 1) {
                alert('创建新方案成功!');
                window.location.reload();
            } else {
                alert(obj.msg);
            }
        });
    }

    //补退款
    function append_refund_money(pid, ar_status){
        var ar_num = document.getElementById("ar_num").value;//对象是contents
        var ar_reason = document.getElementById("ar_reason").value;//对象是contents
        $.post('/ajax/append_refund_money', {_xsrf:xsrf, ar_num:ar_num, ar_reason:ar_reason, pid:pid, ar_status:ar_status}, function (data) {
            var obj = jQuery.parseJSON(data);
            if (obj.flag == 1) {
                alert('申请补款成功!');
            } else {
                alert(obj.msg);
            }
        });
    }
    //===========================点击展开关闭效果====================================
    function openShutManager(oSourceObj, oTargetObj, shutAble, oOpenTip, oShutTip){
        var sourceObj = document.getElementById(oSourceObj);
        var targetObj = document.getElementById(oTargetObj);
        if(targetObj.style.display!="none"){
            targetObj.style.display="none";
        } else {
            targetObj.style.display="";
        }
    }
</script>
{% endblock %}






