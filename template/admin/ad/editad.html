{% extends "layout/admin.html" %}
{% block content %}
<div class="row">
   <nav>
   <div class="navbar-header">
      <a class="navbar-brand" href="#">修改广告</a>
   </div>
</nav>
</div>
<div class="row">
    <div class="panel panel-primary">
    <div class="panel-body">
    {%set messages=handler.get_flashed_messages() %}
        {%if messages%}
            <div class="msg">
                {% for type, msg in messages%}
                    <span style="color:red;">{{msg}}</span>
                {% endfor %}
            </div>
        {%endif%}
        <form action="" method="post" enctype="multipart/form-data">
            {{xsrf()}}
        <div class="form-group has-success row">
            <div class=" col-md-1" style="width:100%;">
                    <label class="control-label" style="margin-top:7px;">广告名称</label>
            </div>
            <div class=" col-md-11">
                   <input type="text" class="form-control"  name="imgalt" value="{{ad.imgalt}}" style="width:480px;" />
            </div>
        </div>


            <div class="form-group has-success row">
                <div class=" col-md-1" style="width:100%;">
                    <label class="control-label" style="margin-top:7px;">广告链接</label>
                </div>

                <div class=" col-md-11">
                    <input type="text" class="form-control"  name="url" value="{{ad.url}}" style="width:480px;">
                </div>

            </div>

            <div class="form-group has-success row">
            <div class=" col-md-1" style="width:100%;">
                <label class="control-label" style="margin-top:7px;">广告位置</label>
            </div>
            <div  class=" col-md-4">
                <select class="form-control" name="sel_category" id="sel_category" onchange="category_change(this.value)" data-default="" style="width:230px;margin-right:20px;">
                    <option value="">全部</option>
                    <option value="用户端PC" {{ad.atype.category =='用户端PC' and 'selected' or ''}}>用户端PC</option>
                    <option value="手机端APP" {{ad.atype.category =='手机端APP' and 'selected' or ''}}>手机端APP</option>
                </select>
            </div>
            <div  class=" col-md-4">
                <select class="form-control" name="sel_type" id="sel_type" onchange="SetImg(this.value)" style="width:230px;">
                    {% for at in adtypes %}
                        <option value="{{at.id}}" {{ at.id == ad.atype.id and 'selected' or '' }}>{{at.name}}</option>
                    {% endfor %}
                </select>

            </div>
            <div  class=" col-md-3" style="padding-top: 6px;">
                 <a id="ats" href="{{ad.atype.imagename}}" target="_blank" >查看图示</a>
                </div>
            </div>

            <div class="form-group has-success row">
                <div class="col-md-1" style="width:100%;">
                    <label class="control-label" style="margin-top:7px;">城市</label>
                </div>
                <div class="col-md-4">
                  <select name="province_code" id="province_code" class="form-control" onchange="province_change(this.value,'')" data-default="" style="width:230px;margin-right:20px;">
                      <option value="">全国</option>
                      {% for area in items %}
                      <option value="{{area.code}}" {% if area.id == (ad.city.pid and ad.city.pid.id) %}selected="selected"{%endif%}>{{area.name}}</option>
                      {% endfor %}
                  </select>
                </div>
                <div class=" col-md-4">
                  <select name="city_code" id="city_code" class="form-control" data-default="" style="width:230px;">
                      <option value="">--请选择城市--</option>
                  </select>
                </div>
            </div>
        <div class="form-group has-success row">
            <div class=" col-md-1" style="width:100%;">
                <label class="control-label" style="margin-top:7px;">备注</label>
            </div>
            <div class=" col-md-4">
                <input type="text" class="form-control"  name="remark" value="{{ad.remark or ''}}" style="width:480px;" >
            </div>
            </div>
        <div class="form-group has-success row">
            <div class=" col-md-1" style="width:100%;">
                <label class="control-label" style="margin-top:7px;">广告尺寸</label>
            </div>
            <div class=" col-md-4">
                <input type="text" class="form-control"  name="adsize" value="{{ad.adsize or ''}}" style="width:480px;" >
            </div>
            </div>
            <div class="form-group has-success row">
                <div class=" col-md-1" style="width:100%;">
                <label class="control-label" style="margin-top:7px;">排序</label>
                </div>
                <div class=" col-md-4">
                <input type="text" class="form-control"  name="sort" value="{{ad.sort}}" style="width:480px;" />
            </div>
            </div>
        <div class="form-group has-success row">
                <div class=" col-md-1">
                <label class="control-label" style="margin-top:11px;">是否启用</label>
            </div>
                <div class=" col-md-4">
                <input type="checkbox" class="form-control" style="width:20px; text-align: left;" value="1"  name="status" {% if ad.flag == 1 %}checked="checked"{%endif%} />
            </div>
            </div>
            <div class="form-group has-success row">
                <div class=" col-md-1" style="width:100%;">
                    <label class="control-label" style="margin-top:7px;">广告图片</label>
                </div>
                <div class=" col-md-4">
                    <input type="file" class="form-control" name="file" style="width:480px;">
                </div>
                <div class=" col-md-7">
                   <img src="{{ad.picurl}}"  height="100">
                </div>
            </div>
            <div class="form-group has-success">
                <a class="btn btn-outline btn-warning btn-sm" href="/admin/ads" style="padding:7px 28px;border:1px solid #438bca;color:#438bca;border-radius:4px;font-size:16px;margin-right:30px;">取消</a>
                <input type="submit" name="sub" value="保存" class="btn btn-outline btn-primary btn-sm" style="width:90px;height:32px;background:#438bca;color:#fff;border-radius:4px;border:none;font-size:16px;">
            </div>
        </form>
    </div>
    </div>
</div>

{% endblock %}
{% block js %}
<script>
    $(document).ready(function(){
    　　province_change('{{ ad.city.pid and ad.city.pid.code}}','{{ ad.city and ad.city.code}}');
    });
    function province_change(id, default_id){
        $("#city_code > option").remove();
        $("#city_code").append("<option value=\"0\">--请选择城市--</option>");
        if(id > 0){
            GetSubAreas(id, "city_code", default_id);
        }
    }

    function category_change(id) {
        $("#sel_type > option").remove();
        GetAdLocations(id, "sel_type");
    }

    function GetAdLocations(id,ddl_id) {
        $.get("/ajax/GetAdLocations", {pcode: id, t: Math.random()}, function (data) {
            data = jQuery.parseJSON(data);
            if (data.flag == 1) {
                for (var i = 0; i < data.data.length; i++) {
                    $("#" + ddl_id).append("<option value=\"" + data.data[i]["id"] + "\">" + data.data[i]["name"] + "</option>");
                    if(i==0)
                    {
                         SetImg(data.data[i]["id"]);
                    }
                }
            }
            else {
                alert(data.msg)
            }
        });
    }

    function GetSubAreas(id,ddl_id,default_id) {
    //    alert(default_id);
        $.get("/ajax/GetSubAreas", { pcode: id, is_site:1,  t: Math.random() }, function (data) {
            data = jQuery.parseJSON(data);
            if(data.flag==1){
                for(var i=0; i< data.data.length; i++){
                    if(default_id.length>0){
                        if(data.data[i]["code"]==default_id){
                            $("#" + ddl_id).append("<option value=\"" + data.data[i]["id"] + "\" selected>" + data.data[i]["name"] + "</option>");
                        }
                        else{
                            $("#" + ddl_id).append("<option value=\"" + data.data[i]["id"] + "\">" + data.data[i]["name"] + "</option>");
                        }
                    }
                    else {
                        $("#" + ddl_id).append("<option value=\"" + data.data[i]["id"] + "\">" + data.data[i]["name"] + "</option>");
                    }
                }
            }
            else{
                alert(data.msg)
            }
        });
    }

    function SetImg(id)
    {
        $.get("/ajax/GetAdTypeImg", {pcode: id, t: Math.random()}, function (data) {
            data = jQuery.parseJSON(data);
            if (data.flag == 1) {
                $('#ats').attr('href', '/upload/ad/'+data.data);
            }
        });
    }
</script>
{% endblock %}