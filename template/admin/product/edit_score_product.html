{% extends "layout/admin.html" %}
{% block content %}
<link href="/style2/css/store_bigimg.css" rel="stylesheet">
<script type="text/javascript" src="/style2/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="/style2/js/bigimg.js"></script>

<div class="mskeLayBg"></div>
<div class="row">
    <ol class="breadcrumb">
        <li><a href="/admin/products">产品管理</a></li>
        <li class="active">
            [{{ p.name|default('新建产品') }}]
        </li>
    </ol>
</div>
<div style="color: red; font-size: 0.6em; margin-bottom: 25px;">
    {%set messages=handler.get_flashed_messages() %}
    {%-if messages-%}
    <div id="err_div">
        {% for type, msg in messages%}
        {{msg}}
        {% endfor %}
    </div>
    {%-endif-%}
</div>
<div class="row">
    <form class="form-horizontal" role="form" action="/admin/product/{{p.id|default('0')}}" method="post">
        {{xsrf()}}
        <div class="panel panel-default">
            <h3 class="panel-title" style="width:100%;height:38px;line-height:38px;background:#528acb;color:#fff;padding-left:15px;border-top-left-radius:4px;border-top-right-radius:4px;">基本信息
            </h3>

            <div class="panel-body">
                <div class="form-group">
                    <label class="col-sm-1 control-label">名称</label>
                    <div class="col-sm-6">
                        <input class="form-control txtName" name="pname" type="text" placeholder="名称不能为空"
                               value="{{p.name}}" required style="width:480px;">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-1 control-label">标签</label>
                    <div class="col-sm-3">
                        <input class="form-control txtTags" name="tags" type="text" placeholder="以英文,分隔"
                               value="{{p.tags}}" style="width:480px;">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-1 control-label">
                        简介
                    </label>
                    <div class="col-sm-10">
                        <input class="form-control" name="presume" type="text" placeholder="简介不能为空"
                               value="{{p.resume}}" required style="width:480px;">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-1 control-label">
                        分类
                    </label>
                    <div class="col-sm-11">
                        <select class="form-control" name="pcategory" id="pcategory" style="width:150px;float:left;margin-right:15px;">
                            {% for c in categorys %}
                            <option value="{{c.id}}"  {{default_category.pid ==c.id and 'selected' or ''}}>
                            {{c.name}}
                            </option>
                            {% endfor %}
                        </select>

                        <select class="form-control" name="category" id="category" placeholder="请选择分类" required style="width:150px;float:left;margin-right:15px;">
                        </select>

                        <select class="form-control" name="category3" id="category3"  placeholder="请选择分类" required style="width:150px;">
                        </select>
                    </div>
                </div>

                <input name="type" type="text" id="type">
                <input name="tag0" type="text" id="tag0">
                <input name="tag1" type="text" id="tag1">
                <input name="tag2" type="text" id="tag2">
                <input name="tag3" type="text" id="tag3">

                <!--润滑油的规格参数-->
                <div class="form-group clearfix specificationLube" style="height:250px;">
                    <label class="col-sm-1 control-label">
                        规格参数
                    </label>

                    <div class="col-sm-11 parameter">
                        <ul id="ul0">
                            {% set i = 0 %}
                            {% for lubeA in lubeAs %}
                            <li {% if i==0 %}class=selectTag style="margin-top:20px;" {% endif %}>
                                <a onclick="selectTag('tagContent{{i}}', this)"
                                   href="javascript:void(0)">{{lubeA.name}}</a>
                            </li>
                            {% set i=i+1 %}
                            {% endfor %}
                        </ul>
                        <img src="/style2/images/jt.png" />
                        <div id="tagContent">
                            {% set j=0 %}
                            {% for lubeA in lubeAs %}
                            <div {% if j==0 %}class="tagContent selectTag"{% else %} class="tagContent"{%endif%} id="tagContent{{j}}">
                                <ul>
                                    {% set i=0 %}
                                    {% for PPTAQ in PPTAQuantity.select().where(PPTAQuantity.PPTA_id==(j+1)) %}
                                    <li><a onclick="tagContent{{j}}({{i}})" href="#">{{PPTAQ.name}}</a></li>

                                    {% set i=i+1 %}
                                    {% endfor %}
                                </ul>
                            </div>
                            {% set j=j+1 %}
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!--导航仪的规格参数-->
                <div class="form-group clearfix specificationNavigator" name="navigator" style="height:250px;">
                    <label class="col-sm-1 control-label">
                        规格参数
                    </label>
                    <div class="col-sm-11 parameter">
                        <ul id="ul0x">
                            {% set i = 0 %}
                            {% for navigator in navigators %}
                            <li {% if i==0 %}class=selectTag style="margin-top:20px;" {% endif %}>
                                <a onclick="selectTagx('tagContentx{{i}}', this)"
                                   href="javascript:void(0)">{{navigator.name}}</a>
                            </li>
                            {% set i=i+1 %}
                            {% endfor %}
                        </ul>
                        <img src="/style2/images/jt.png" />
                        <div id="tagContentx">
                            {% set j=0 %}
                            {% for navigator in navigators %}
                            <div {% if j==0 %}class="tagContent selectTag"{% else %} class="tagContent"{%endif%} id="tagContentx{{j}}"  name="attribute{{j}}">
                                <ul>
                                    {% set i=0 %}
                                    {% for PPTAQ in PPTAQuantity.select().where(PPTAQuantity.PPTA_id==(j+6)) %}
                                    <li><a onclick="tagContentx{{j}}({{i}})" href="#">{{PPTAQ.name}}</a></li>
                                    {% set i=i+1 %}
                                    {% endfor %}
                                </ul>
                            </div>
                            {% set j=j+1 %}
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!--记录仪的规格参数-->
                <div class="form-group clearfix specificationRecorder" name="recorder" style="height:250px;">
                    <label class="col-sm-1 control-label">
                        规格参数
                    </label>
                    <div class="col-sm-11 parameter">
                        <ul id="ul0y">
                            {% set i = 0 %}
                            {% for recorder in recorders %}
                            <li {% if i==0 %}class=selectTag style="margin-top:20px;" {% endif %}>
                                <a onclick="selectTagy('tagContenty{{i}}', this)"
                                   href="javascript:void(0)">{{recorder.name}}</a>
                            </li>
                            {% set i=i+1 %}
                            {% endfor %}
                        </ul>
                        <img src="/style2/images/jt.png" />
                        <div id="tagContenty">
                            {% set j=0 %}
                            {% for recorder in recorders %}
                            <div {% if j==0 %}class="tagContent selectTag"{% else %} class="tagContent"{%endif%} id="tagContenty{{j}}" name="attribute{{j}}">
                                <ul>
                                    {% set i=0 %}
                                    {% for PPTAQ in PPTAQuantity.select().where(PPTAQuantity.PPTA_id==(j+9)) %}
                                    <li><a onclick="tagContenty{{j}}({{i}})" href="#">{{PPTAQ.name}}</a></li>
                                    {% set i=i+1 %}
                                    {% endfor %}
                                </ul>
                            </div>
                            {% set j=j+1 %}
                            {% endfor %}
                        </div>
                    </div>
                </div>


                <div class="form-group">
                    <label class="col-sm-1 control-label">
                        配件品牌
                    </label>
                    <div class="col-sm-11">
                        <select class="form-control" name="pptype" id="pptype" style="width:230px;float:left;margin-right:20px;">
                            <option value="">
                                请选择配件分类
                            </option>
                            {% for c in pptype %}
                            <option value="{{c.id}}" {{p.pinpai and(p.pinpai.ptype.id ==c.id and 'selected' or '')}}>
                            {{c.name}}
                            </option>
                            {% endfor %}
                        </select>
                        <select class="form-control" name="pinpai" id="pinpai"  placeholder="请选择配件品牌" required style="width:230px;">
                            <option value="">
                                请选择配件品牌
                            </option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-1 control-label">
                        是否普通
                    </label>
                    <div class="col-sm-11">
                        <select class="form-control" name="is_index" id="is_index" required style="width:480px;">
                            <option value="0" {{p.is_index==0 and 'selected' or ''}}>
                            普通商品
                            </option>
                            <option value="1" {{p.is_index==1 and 'selected' or ''}}>
                            保险商品
                            </option>
                            <option value="2" {{p.is_index==2 and 'selected' or ''}}>
                            钣喷商品
                            </option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-1 control-label">
                        详细介绍
                    </label>
                    <div class="col-sm-10">
                        <textarea class="form-control" rows="10" name="pintro" id="pintro">{{p.intro}}</textarea>
                    </div>
                </div>
                <div class="form-group">
                    <label  class="col-sm-1 control-label">
                        关键字
                    </label>
                    <div class="col-sm-11">
                        <input class="form-control" rows="3" id="pmetakeywords" name="pmetakeywords" value="{{p.metakeywords}}" style="width:480px;" />
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-1 control-label">
                        简短描述
                    </label>
                    <div class="col-sm-11">
                        <input type="text" class="form-control" name="pmetadescription" value="{{p.metadescription}}" style="width:480px;">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-1 control-label" >
                        标题标记
                    </label>
                    <div class="col-sm-11">
                        <input type="text" class="form-control" name="pmetatitle" value="{{p.metatitle}}" style="width:480px;">
                    </div>
                </div>
            </div>
        </div>
        {%-if p-%}
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">图片信息 <a href="" id="fileupload" style="font-size:14px;cursor:pointer;">选择图片</a></h3>
            </div>
            <div class="aa"></div>
            <div class="mskelayBox">
                <div class="mske_html">
                </div>
                <img class="mskeClaose" src="/style2/images/mke_close.png" width="27" height="27" />
            </div>
            <div class="panel-body" id="pic-box">
                {% for c in p.pics -%}
                <div class="col-lg-2 .col-xs-10">
                    {%-if p.cover==c.path -%}
                    <div class="panel panel-primary">
                    {% else %}
                    <div class="panel panel-default">
                    {% endif %}
                            <div class="panel-heading center-block">
                                <img class="preview" src="{{c.path}}" width="80" height="80">
                            </div>
                            <div class="panel-footer">
                                <div class="btn-group btn-group-xs">
                                    <a type="button" class="btn btn-default" href="/admin/delpic/{{c.id}}">删除</a>
                                    {%-if not p.cover==c.path -%}
                                    <a type="button" class="btn btn-default" href="/admin/primarypic/{{c.id}}">设为主图</a>
                                    {% endif %}
                                </div>
                            </div>
                            <span class="hidden" style="diplay:none">
									<img id="example2"/>
								</span>
                        </div>

                    </div>
                    {%- endfor %}
                </div>
            </div>
        </div>
        {%-endif-%}
        {% if is_add == '1' %}
        <button type="submit" style="width:90px;height:32px;background:#528acb;color:#fff;border:none;font-size:14px;border-radius:4px;margin-bottom:30px;">保存</button>
        {% endif %}
    </form>
</div>
{% endblock %}
{% block js %}
<!--<script src="/style2/js/jquery-1.7.2.min.js?v=1"></script>-->
<script src="/style2/xheditor/xheditor-1.2.2.min.js"></script>
<script src="/style2/xheditor/xheditor_lang/zh-cn.js"></script>
<script src="/style2/js/jquery_ocupload.js?v=1"></script>
<script language="javascript" type="text/javascript" src="/style2/js/My97DatePicker/WdatePicker.js"></script>
<script>
    $(function(){
        var xsrf='{{handler.xsrf_token}}';
        $(".specificationLube").hide();
        $(".specificationNavigator").hide();
        $(".specificationRecorder").hide();
        $('#type').hide();
        $('#tag0').hide();
        $('#tag1').hide();
        $('#tag2').hide();
        $('#tag3').hide();

        $("#pcategory").change(function(){
            //debugger;
            var pid = $(this).val();
            $.get("/ajax/get_sub_category", { _xsrf : xsrf , pid : pid}, function (data) {
                data = jQuery.parseJSON(data);
                var optionstring = "";
                if(data.flag == 1) {
                    for (var j = 0; j < data.data.length; j++) {
                        optionstring += "<option value=\"" + data.data[j].id + "\" >" + data.data[j].name + "</option>";
                    }
                    $("#category").html("<option value=''>请选择...</option> " + optionstring);
                }
            });
        });
        $("#pcategory").change();
        $("#pptype").change(function(){
//            debugger;
            var pid = $(this).val();
            $.get("/ajax/get_pinpai", { _xsrf : xsrf , pid : pid}, function (data) {
                data = jQuery.parseJSON(data);
                var optionstring = "";
                if(data.flag == 1) {
                    for (var j = 0; j < data.data.length; j++) {
                        optionstring += "<option value=\"" + data.data[j].id + "\" >" + data.data[j].name + "</option>";
                    }
                    $("#pinpai").html("<option value=''>请选择配件品牌</option> " + optionstring);
                    {% if p.pinpai %}
                        $("#pinpai option[value='{{p.pinpai.id}}']").attr("selected", true);
                    {% endif %}
                }
            });
        });
        
        $("#pptype").change();
        $('#pintro').xheditor({tools:'Source,Fullscreen,Img', html5Upload:false, upImgUrl:"/ajax/upload",upImgExt:"jpg,gif,png"});

        var myUpload = $('#fileupload').upload({
            name: 'filedata',
            action: '/ajax/product/pic/{{p.id}}',
            enctype: 'multipart/form-data',
            autoSubmit: true,
            onClick: function(){

            },
            onSelect: function(){
                var filename=myUpload.filename();
                var ext = filename.substr(filename.length - 3, 3).toLowerCase();
                if (ext != 'jpg' || ext != 'gif' || ext != 'png')
                {
                    return false;
                }
            },
            onComplete: function(response) {
                eval('var c = ' + response);
                if (c.id > 0) {
                    $('#pic-box').append('<div class="col-lg-2 .col-xs-12"><div class="panel panel-default"><div class="panel-heading center-block"><img src="' + c.path + '" width="80" height="80"></div><div class="panel-footer"><div class="btn-group btn-group-xs"><a type="button" class="btn btn-default" href="/admin/delpic/'+c.id+'">删除</a><a type="button" class="btn btn-default" href="/admin/primarypic/'+c.id+'">设为主图</a></div></div></div></div>');

                }
                else{
                    alert(c.path);
                }

            }
        });
//        query();
//        $(".txtName").change(function(){
//            query();
//        });

        $("#pcategory").change(function(){
            var pid = $(this).val();
            $.get("/ajax/get_sub_category", { _xsrf : xsrf , pid : pid}, function (data) {
                data = jQuery.parseJSON(data);
                var optionstring = "";
                if(data.flag == 1) {
                    for (var j = 0; j < data.data.length; j++) {
                        optionstring += "<option value=\"" + data.data[j].id + "\" >" + data.data[j].name + "</option>";
                    }
                    $("#category").html("<option value=''>请选择...</option> " + optionstring);
                    {% if default_category2 %}
                        $("#category option[value='{{default_category2}}']").attr("selected", true);
                        $("#category").change();
                    {% endif %}
                }
            });
        });
        $("#category").change(function(){
            var pid = $(this).val();
            $.get("/ajax/get_sub_category", { _xsrf : xsrf , pid : pid}, function (data) {
                data = jQuery.parseJSON(data);
                var optionstring = "";
                if(data.flag == 1) {
                    for (var j = 0; j < data.data.length; j++) {
                        optionstring += "<option value=\"" + data.data[j].id + "\" >" + data.data[j].name + "</option>";
                    }
                    $("#category3").html("<option value=''>请选择...</option> " + optionstring);
                    {% if default_category3 %}
                        $("#category3 option[value='{{default_category3}}']").attr("selected", true);
                    {% endif %}
                    if(pid==121){  //CategoryFront表中润滑油ID
                        $(".specificationLube").show();
                        $(".specificationNavigator").hide();
                        $(".specificationRecorder").hide();
                        $("#type").val('lube');
                    }else if(pid==141){  //CategoryFront表中导航仪ID
                        $(".specificationLube").hide();
                        $(".specificationNavigator").show();
                        $(".specificationRecorder").hide();
                        $("#type").val('navigator');
                    }else if(pid==142){  //CategoryFront表中记录仪ID
                        $(".specificationLube").hide();
                        $(".specificationNavigator").hide();
                        $(".specificationRecorder").show();
                        $("#type").val('recorder');
                    }else{
                        $(".specificationLube").hide();
                        $(".specificationNavigator").hide();
                        $(".specificationRecorder").hide();
                    }
                    
                }
            });
        });
        {% if p %}
            $("#pcategory option[value='{{default_category.id}}']").attr("selected", true);
        {% endif %}
        $("#pcategory").change();

    });
    //两端去空格函数
    String.prototype.trim = function() {
        return this.replace(/(^\s*)|(\s*$)/g,"");
    }


</script>
{% endblock %}




