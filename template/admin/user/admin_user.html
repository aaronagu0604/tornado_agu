{% extends "layout/admin.html" %}
{% block content %}
<div class="row">
    <ol class="breadcrumb">
        <li>后台用户管理</li>
    </ol>
</div>
<div style="color: red; font-size: 0.6em; margin-bottom: 25px;">
    {% set messages=handler.get_flashed_messages() %}
    {% if messages %}
    <div>
        {% for type, msg in messages%}
        {{msg}}
        {% endfor %}
    </div>
    {% endif %}
</div>
<form class="form-horizontal" id="form" method="post" action="/admin/admin_user/{{adminUser and adminUser.id or 0}}">
    {{xsrf()}}
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <h3 class="panel-title" style="background:#438bca;color:#fff;width:100%;height:38px;line-height:38px;border-top-left-radius: 4px;
border-top-right-radius: 4px;padding-left:15px;
">添加/修改用户
                </h3>
                <div class="panel-body" style="margin-left:20px;">
                    <table class="table table-condensed">
                        <tbody>
                        <tr style="border:none;">
                            <th>
                                <input type="text" id="username" class="form-control" value="{{adminUser.username}}" name="username" placeholder="用户名不能为空！" style="width:480px;">
                            </th>
                        </tr>
                        <tr style="border:none;">
                            <th>
                                <input type="password" class="form-control" id="password" name="password" placeholder="用户密码初始密码不能为空，不修改请为空！" style="width:480px;">
                            </th>
                        </tr>
                        <tr style="border:none;">
                            <th>
                                <input type="text" class="form-control" value="{{adminUser.realname}}" name="realname" placeholder="请输入真实姓名！" style="width:480px;">
                            </th>
                        </tr>
                        <tr style="border:none;">
                            <th>
                                <input type="text" class="form-control" value="{{adminUser.mobile}}" name="mobile" placeholder="请输入手机号！" style="width:480px;">
                            </th>
                        </tr>
                        <tr style="border:none;">
                            <th>
                                <input type="text" class="form-control" value="{{adminUser.code}}" name="code" placeholder="请输入工号！" style="width:480px;">
                            </th>
                        </tr>
                        {% if handler.vrole('AD') %}
                        <tr style="border:none;">
                            <th>
                                <input type="text" class="form-control" value="{{adminUser.roles}}" name="roles" placeholder="请输入角色:D开发人员,A管理员,Y运营,S市场,K客服;可组合,如:YS！"style="width:480px;">
                            </th>
                        </tr>
                        <tr style="border:none;">
                            <th>
                                <label class="num">服务地区： </label>
                                <select name="province_code" id="province_code" onchange="province_change(this.value,0)" data-default="{{default_province}}" style="height:28px;margin-left:10px;margin-top:10px;border-radius:4px;" >
                                    <option value="">--选择省份--</option>
                                    {% for area in items %}
                                    <option value="{{area.code}}" {{area.code==default_province and 'selected' or ''}}>{{area.name}}</option>
                                    {% endfor %}
                                </select>
                                <select name="city_code" id="city_code" onchange="city_change(this.value,0)" data-default="{{default_city}}" style="height:28px;margin-left:10px;margin-top:10px;border-radius:4px;" >
                                    <option value="">--选择城市--</option>
                                </select>
                                <select name="district_code" id="district_code" data-default="{{default_district}}" style="height:28px;margin-left:10px;margin-top:10px;border-radius:4px;">
                                    <option value="">--选择区县--</option>
                                </select>
                            </th>
                        </tr>
                        <tr style="border:none;">
                            <th>
                                <input type="checkbox" name="active" {% if adminUser and adminUser.active==1%}checked='true'{%endif%}>是否启用
                            </th>
                        </tr>
                        {% endif %}
                        </tbody>
                    </table>
                    <input type="submit" value="保存" class="btn btn-outline btn-default btn-xs" style="width:90px;height:32px;background:#438bca;color:#fff;border:none;border-radius:4px;font-size:16px;">
                    <a href="/admin/admin_user/0">新建用户</a>
                </div>
            </div>
        </div>
        {% if handler.vrole('AD') %}
        <div class="col-lg-12">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title">用户列表　
                    </h3>
                </div>
                <div class="panel-body">

                    <div class="table-responsive">
                        <table class="table table-hover" id="tb_users" style="text-align:center;">
                            <tbody>
                            <tr>
                                <th style="width:10%;text-align:center;">ID</th>
                                <th style="width:10%;text-align:center;">用户名</th>
                                <th style="width:10%;text-align:center;">真实姓名</th>
                                <th style="width:10%;text-align:center;">用户角色</th>
                                <th style="width:10%;text-align:center;">服务地区</th>
                                <th style="width:10%;text-align:center;">手机</th>
                                <th style="width:20%;text-align:center;">最后登录时间</th>
                                <th style="width:10%;text-align:center;">帐户状态</th>
                                <th style="width:10%;text-align:center;">操作</th>
                            </tr>
                            {% for o in ivs %}
                            <tr>
                                <td>{{o.id}}</td>
                                <td>{{o.username}}</td>
                                <td>{{o.realname}}</td>
                                <td>{{o.roles}}</td>
                                <td>{{Area().get_detailed_address(o.area_code)}}</td>
                                <td>{{o.mobile}}</td>
                                <td>{{o.lsignined | datetimeformat}}</td>
                                <td>{{o.isactive==0 and '<span style="color:#ff5231;">删除</span>' or '<span style="color:#438bca;">启用</span>'}}</td>
                                <td><a class="btn btn-outline btn-primary btn-xs" href="/admin/admin_user/{{o.id}}">编辑</a></td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        <div>
                            <div class="col-sm-4">
                                <div class="dataTables_info" role="alert" aria-live="polite" aria-relevant="all">
                                    当前：第{{page}}页 / {{totalpage}}页，合计{{total}}条
                                </div>
                            </div>
                            <div class="col-sm-8">
                                <div class="dataTables_paginate paging_simple_numbers">
                                    <ul class="pagination  pagination-sm" id="pageUl" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</form>
{% endblock %}
{% block js %}
<script src="/style/js/jquery.twbsPagination.min.js"></script>
<script>
    $(document).ready(function() {
        $('#pageUl').twbsPagination({
            first:'首页',
            prev:'上一页',
            next:'下一页',
            last:'尾页',
            totalPages: {{totalpage}},
            startPage: {{page}},
            visiblePages: 8,
                onPageClick: function (event, page) {
                self.location="/admin/admin_user/"+{{adminUser and adminUser.id or 0}}+"?page="+page;//{{store.id}}/{{adminUser and adminUser.id or 0}}
            }
        });
    });

    $(function(){
        init_province();
    });
    function init_province(){
        var province_code=$("#province_code").attr("data-default");
        var city_code=$("#city_code").attr("data-default");
        var district_code=$("#district_code").attr("data-default");
        console.debug(city_code)
        if(province_code.length > 0){
            province_change(province_code, city_code);
            if(parseInt(city_code)){
                city_change(city_code, district_code)
            }
        }
    }
    function province_change(id, default_id){
        $("#district_code > option").remove();
        $("#district_code").append("<option value=\"0\">--选择区县--</option>");
        $("#city_code > option").remove();
        $("#city_code").append("<option value=\"0\">--选择城市--</option>");
        if(id > 0){
            GetSubAreas(id, "city_code", default_id);
        }
    }
    function city_change(id, default_id){
        $("#district_code > option").remove();
        $("#district_code").append("<option value=\"0\">--选择区县--</option>");
        if(id > 0){
            GetSubAreas(id, "district_code", default_id);
        }
    }
    function GetSubAreas(id, ddl_id, default_id) {
        $.get("/ajax/GetSubAreas", { parent_code: id,  t: Math.random() }, function (data) {
            data = jQuery.parseJSON(data);
            if(data.flag==1){
                for(var i=0; i< data.data.length; i++){
                    if(default_id.length > 0){
                        if(data.data[i]["code"] == default_id){
                            $("#" + ddl_id).append("<option value=\"" + data.data[i]["code"] + "\" selected>" + data.data[i]["name"] + "</option>");
                        } else{
                            $("#" + ddl_id).append("<option value=\"" + data.data[i]["code"] + "\">" + data.data[i]["name"] + "</option>");
                        }
                    } else {
                        $("#" + ddl_id).append("<option value=\"" + data.data[i]["code"] + "\">" + data.data[i]["name"] + "</option>");
                    }
                }
            } else {
                alert(data.msg)
            }
        });
    }
</script>
{% endblock %}