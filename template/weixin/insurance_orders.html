<!--订单列表页面-->
{% extends "weixin/none_foot_nav_tab.html" %}
{% block css %}
<title>订单列表</title>
<style>
    .weui-navbar__item.weui-bar__item--on {
        color: #42d161;
        background-color: #fff;
        border-bottom: 2px solid;
    }

    .weui-navbar__item:after {
        border-right: 0 solid #ccc;
    }

</style>
{% endblock %}
{% block content %}
<div class="weui-tab czj_wx_body">
    <div class="weui-navbar order-list-tab-bar">
        <a type="all" class="weui-navbar__item weui-bar__item--on" href="#tab1">
            全部
        </a>
        <a type="unverify" class="weui-navbar__item" href="#tab2">
            待核价
        </a>
        <a type="unpay" class="weui-navbar__item" href="#tab3">
            待付款
        </a>
        <a type="paid" class="weui-navbar__item" href="#tab4">
            已付款
        </a>
        <a type="success" class="weui-navbar__item" href="#tab5">
            已完成
        </a>
    </div>
    <div class="weui-tab__bd">
        <div id="loadMoreContainer">
            <div class="weui-pull-to-refresh__layer">
                <div class="weui-pull-to-refresh__arrow"></div>
                <div class="weui-pull-to-refresh__preloader"></div>
                <div class="down">下拉刷新</div>
                <div class="up">释放刷新</div>
                <div class="refresh">正在刷新</div>
            </div>
            <div id="tab1" class="weui-tab__bd-item weui-tab__bd-item--active">
            </div>
            <div id="tab2" class="weui-tab__bd-item">
                <h1>页面二</h1>
            </div>
            <div id="tab3" class="weui-tab__bd-item">
                <h1>页面三</h1>
            </div>
            <div id="tab4" class="weui-tab__bd-item">
                <h1>页面4</h1>
            </div>
            <div id="tab5" class="weui-tab__bd-item">
                <h1>页面5</h1>
            </div>
            <div class="weui-loadmore">
                <i class="weui-loading"></i>
                <span class="weui-loadmore__tips">正在加载</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block js %}
<script>
    var loading = false; //上拉状态标记
    var index = 1;
    //加载更多，flag=0刷新，falg==1加载更多
    function loadmore(flag) {
        var type = $(".weui-bar__item--on").attr('type');
        var current_tab = 'tab' + type;

        if (flag == 0) {
            index = 1;
        }

        jQuery.getJSON("/wxapi/insurance_orders", {
            'index': index,
            'type': type
        }, function (data) {
            console.log(data);
            if (data.flag == 1) {
                if (flag == 0) {
                    $('#' + current_tab).html('');
                    $('#loadMoreContainer').pullToRefreshDone();
                }
                else {
                    index = index + 1;
                }
                for (var i = 0; i < data.data.length; i++) {
                    var html = OrderItemToHtml(data.data[i]);
                    $('#' + current_tab).append(html);
                }
                if (data.data.length < 10) {
                    $(".weui-loadmore").hide();
                    $(document.body).destroyInfinite();
                }
                if (data.data.length >= 10 && flag == 0) {
                    $(document.body).destroyInfinite();
                    $(document.body).infinite().on("infinite", function () {
                        if (loading) return;
                        loading = true;
                        loadmore(1);
                    });
                }
            }
            loading = false;
        });
    }

    function OrderItemToHtml(data) {
        var html = '<a href="/insurance_order_detail">\
                    <div class="weui-panel">\
                        <div class="weui-panel__hd order_title">\
                            <div class="weui-flex">\
                                <div class="weui-flex__item order-num">\
                                    订单编号:{{data['ordernum']}}\
                                </div>\
                                <div class="weui-flex__item order-status">\
                                    <span>待付款</span>\
                                </div>\
                            </div>\
                        </div>\
                        <div class="weui-panel__bd order-bd">\
                            <div class="weui-flex">\
                                <div class="weui-flex__item left">\
                                    保险公司:人保车险\
                                </div>\
                                <div class="weui-flex__item right">\
                                    2017-06-08\
                                </div>\
                            </div>\
                            <div class="weui-flex">\
                                <div class="weui-flex__item left">\
                                    寄送人:车装甲\
                                </div>\
                                <div class="weui-flex__item right" >\
                                    13389202678\
                                </div>\
                            </div>\
                            <div class="weui-flex">\
                                <div class="weui-flex__item left">\
                                    陕西省西安市新城区陕西省西安市新城区陕西省西安市新城区陕西省西安市新城区陕西省西安市新城区\
                                </div>\
                            </div>\
                        </div>\
                        <div class="order-split-line"></div>\
                        <div class="weui-panel__ft order-ft">\
                            <div class="weui-flex">\
                                <div class="weui-flex__item" style=" flex: 3;">\
                                    <span class="order_price_title">订单金额:</span><span style="font-size: 13px; color:red;">￥</span><span class="order_price">1020</span>\
                                </div>\
                                <div class="weui-flex__item" style=" flex: 5;text-align: right;">\
                                    <a href="#" class="weui-btn weui-btn_mini weui-btn_primary">\
                                        立即支付</a>\
                                    <a href="#" class="weui-btn weui-btn_mini czj-btn-yellow"\
                                       style="margin-top: 0;">\
                                        扫码支付</a>\
                                </div>\
                            </div>\
                        </div>\
                    </div>\
                </a>';
        return html;
    }

    $('#loadMoreContainer').pullToRefresh().on("pull-to-refresh", function () {
        loadmore(0);
    });

    loadmore(0);

    $(document).on("click", "#soon_pay", function () {
        $.actions({
            title: "支付方式", actions: [{
                text: "微信", onclick: function () {

                }
            }, {
                text: "支付宝", onclick: function () {

                }
            }]
        });
    })

    $(document).on("click", "#code_pay", function () {
        $.actions({
            title: "扫码支付", actions: [{
                text: "微信扫码", onclick: function () {
                    document.location.href = "/pay_detail";
                }
            }, {
                text: "支付宝扫码", onclick: function () {
                    document.location.href = "/pay_detail";
                }
            }]
        });
    })

</script>
{% endblock %}